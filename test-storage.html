<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Storage Test - Portal</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .nav-link {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-link:hover {
            background: #0056b3;
        }
        
        .success {
            color: green;
            font-weight: bold;
        }
        
        .error {
            color: red;
            font-weight: bold;
        }
        
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div style="margin-bottom: 20px;">
            <a href="index.html" class="nav-link">‚Üê Back to Login</a>
            <a href="file-manager.html" class="nav-link">File Manager</a>
        </div>
        
        <h1>üß™ File Storage System Test</h1>
        
        <div class="info">
            <strong>File Storage Test Suite</strong><br>
            This page tests the file-based storage system for the login portal.
            All user data will be stored in downloadable JSON files.
        </div>

        <div class="test-section">
            <h3>1. System Status</h3>
            <p id="systemStatus">Checking system...</p>
            <button onclick="checkSystem()">Check System</button>
        </div>

        <div class="test-section">
            <h3>2. Add Test Users</h3>
            <button onclick="addTestUsers()">Add 3 Test Users</button>
            <p id="addUsersResult"></p>
        </div>

        <div class="test-section">
            <h3>3. View Current Users</h3>
            <button onclick="loadUsers()">Load Users from File</button>
            <div id="usersList"></div>
        </div>

        <div class="test-section">
            <h3>4. Export/Import Test</h3>
            <button onclick="exportUsers()">Export Users to File</button>
            <button onclick="createBackup()">Create Backup</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importUsers(this)">
            <button onclick="document.getElementById('importFile').click()">Import Users from File</button>
            <p id="exportResult"></p>
        </div>

        <div class="test-section">
            <h3>5. User Authentication Test</h3>
            <button onclick="testAuthentication()">Test Login/Registration</button>
            <p id="authResult"></p>
        </div>

        <div class="test-section">
            <h3>6. Clear Data</h3>
            <button onclick="clearAllData()" style="background: #dc3545;">Clear All Users</button>
            <p id="clearResult"></p>
        </div>

        <div class="test-section">
            <h3>Test Results Log</h3>
            <div id="testLog"></div>
        </div>
    </div>

    <script src="file-storage.js"></script>
    <script>
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            testLog.push(`[${timestamp}] ${message}`);
            
            const logDiv = document.getElementById('testLog');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Test 1: Check system
        async function checkSystem() {
            try {
                log('Checking file storage system...');
                
                // Check if FileStorageHandler exists
                if (typeof fileStorage === 'undefined') {
                    throw new Error('FileStorageHandler not loaded');
                }
                
                // Try to load users
                const users = await fileStorage.loadUsers();
                log(`System OK - Loaded ${users.length} users`, 'success');
                
                document.getElementById('systemStatus').innerHTML = 
                    `<span class="success">‚úÖ System Working - ${users.length} users loaded</span>`;
                
            } catch (error) {
                log(`System Error: ${error.message}`, 'error');
                document.getElementById('systemStatus').innerHTML = 
                    `<span class="error">‚ùå System Error: ${error.message}</span>`;
            }
        }

        // Test 2: Add test users
        async function addTestUsers() {
            try {
                log('Adding test users...');
                
                const testUsers = [
                    {
                        email: 'test1@example.com',
                        username: 'testuser1',
                        password: fileStorage.hashPassword('password123'),
                        emailVerified: true,
                        createdAt: new Date().toISOString()
                    },
                    {
                        email: 'test2@example.com',
                        username: 'testuser2',
                        password: fileStorage.hashPassword('password456'),
                        emailVerified: false,
                        createdAt: new Date().toISOString()
                    },
                    {
                        email: 'admin@example.com',
                        username: 'admin',
                        password: fileStorage.hashPassword('admin123'),
                        emailVerified: true,
                        createdAt: new Date().toISOString()
                    }
                ];

                let users = await fileStorage.loadUsers();
                
                // Add users if they don't exist
                for (const testUser of testUsers) {
                    if (!users.find(u => u.email === testUser.email)) {
                        users.push(testUser);
                    }
                }

                await fileStorage.saveUsers(users);
                log(`Added test users successfully`, 'success');
                
                document.getElementById('addUsersResult').innerHTML = 
                    `<span class="success">‚úÖ Test users added successfully</span>`;
                
            } catch (error) {
                log(`Failed to add test users: ${error.message}`, 'error');
                document.getElementById('addUsersResult').innerHTML = 
                    `<span class="error">‚ùå Failed: ${error.message}</span>`;
            }
        }

        // Test 3: Load and display users
        async function loadUsers() {
            try {
                log('Loading users from storage...');
                
                const users = await fileStorage.loadUsers();
                log(`Loaded ${users.length} users`, 'success');
                
                const usersList = document.getElementById('usersList');
                if (users.length === 0) {
                    usersList.innerHTML = '<p>No users found</p>';
                    return;
                }

                usersList.innerHTML = `
                    <h4>Users (${users.length}):</h4>
                    <pre>${JSON.stringify(users.map(u => ({
                        email: u.email,
                        username: u.username,
                        verified: u.emailVerified,
                        created: u.createdAt
                    })), null, 2)}</pre>
                `;
                
            } catch (error) {
                log(`Failed to load users: ${error.message}`, 'error');
                document.getElementById('usersList').innerHTML = 
                    `<span class="error">‚ùå Failed to load users</span>`;
            }
        }

        // Test 4: Export users
        async function exportUsers() {
            try {
                log('Exporting users to file...');
                
                const users = await fileStorage.loadUsers();
                await fileStorage.exportUsersFile(users);
                
                log('Users exported successfully', 'success');
                document.getElementById('exportResult').innerHTML = 
                    `<span class="success">‚úÖ Users exported to download</span>`;
                
            } catch (error) {
                log(`Export failed: ${error.message}`, 'error');
                document.getElementById('exportResult').innerHTML = 
                    `<span class="error">‚ùå Export failed</span>`;
            }
        }

        // Create backup
        async function createBackup() {
            try {
                log('Creating backup...');
                
                const users = await fileStorage.loadUsers();
                fileStorage.createBackup(users);
                
                log('Backup created successfully', 'success');
                document.getElementById('exportResult').innerHTML = 
                    `<span class="success">‚úÖ Backup created</span>`;
                
            } catch (error) {
                log(`Backup failed: ${error.message}`, 'error');
            }
        }

        // Test import
        async function importUsers(input) {
            try {
                log('Importing users from file...');
                
                const importedUsers = await fileStorage.importUsersFile(input);
                
                if (confirm(`Import ${importedUsers.length} users? This will replace current data.`)) {
                    await fileStorage.saveUsers(importedUsers);
                    log(`Imported ${importedUsers.length} users successfully`, 'success');
                    
                    document.getElementById('exportResult').innerHTML = 
                        `<span class="success">‚úÖ Imported ${importedUsers.length} users</span>`;
                    
                    loadUsers(); // Refresh display
                }
                
            } catch (error) {
                log(`Import failed: ${error.message}`, 'error');
                document.getElementById('exportResult').innerHTML = 
                    `<span class="error">‚ùå Import failed</span>`;
            }
        }

        // Test 5: Authentication test
        async function testAuthentication() {
            try {
                log('Testing authentication system...');
                
                const users = await fileStorage.loadUsers();
                const testUser = users.find(u => u.email === 'test1@example.com');
                
                if (!testUser) {
                    throw new Error('Test user not found. Please add test users first.');
                }

                // Test password verification
                const isValidPassword = fileStorage.verifyPassword('password123', testUser.password);
                
                if (isValidPassword) {
                    log('Password verification test passed', 'success');
                    document.getElementById('authResult').innerHTML = 
                        `<span class="success">‚úÖ Authentication test passed</span>`;
                } else {
                    throw new Error('Password verification failed');
                }
                
            } catch (error) {
                log(`Authentication test failed: ${error.message}`, 'error');
                document.getElementById('authResult').innerHTML = 
                    `<span class="error">‚ùå Authentication test failed</span>`;
            }
        }

        // Test 6: Clear data
        async function clearAllData() {
            if (confirm('Are you sure you want to clear all user data?')) {
                try {
                    log('Clearing all user data...');
                    
                    await fileStorage.saveUsers([]);
                    log('All user data cleared', 'success');
                    
                    document.getElementById('clearResult').innerHTML = 
                        `<span class="success">‚úÖ All data cleared</span>`;
                    
                    loadUsers(); // Refresh display
                    
                } catch (error) {
                    log(`Failed to clear data: ${error.message}`, 'error');
                    document.getElementById('clearResult').innerHTML = 
                        `<span class="error">‚ùå Failed to clear data</span>`;
                }
            }
        }

        // Initialize test page
        document.addEventListener('DOMContentLoaded', () => {
            log('File Storage Test Page Initialized');
            checkSystem();
        });
    </script>
</body>
</html>
